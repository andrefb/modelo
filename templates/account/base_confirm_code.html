{% extends "base_auth.html" %}
{% load i18n %}
{% load account %}
{% load widget_tweaks %}

{% block head_title %}Código Enviado{% endblock %}
{% block sub_title %}Verifique seu email{% endblock %}

{% block content %}

<!-- CORREÇÃO 1: action vazio faz o form enviar para a PRÓPRIA URL atual -->
<form method="post" action="" class="space-y-6">
    {% csrf_token %}

    <div class="text-center">
        <p class="text-sm text-slate-600">
            Enviamos um código de verificação para o seu email.<br>
            <strong>Digite-o abaixo para liberar seu acesso.</strong>
        </p>
    </div>

    <!-- Loop do Formulário -->
    {% for field in form %}
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest text-center mb-2">
                Código de 6 Dígitos
            </label>
            
            {% if field.errors %}
                {% render_field field class="w-full px-4 py-4 text-center text-3xl font-mono font-bold tracking-[0.5em] text-red-600 border-2 border-red-300 bg-red-50 rounded-xl focus:ring-0 outline-none uppercase" placeholder="------" autofocus="autofocus" %}
                <p class="mt-2 text-sm text-red-500 text-center font-medium">{{ field.errors.0 }}</p>
            {% else %}
                {% render_field field class="w-full px-4 py-4 text-center text-3xl font-mono font-bold tracking-[0.5em] text-brand border-2 border-gray-200 rounded-xl focus:border-brand focus:ring-0 outline-none transition-all placeholder-gray-200 bg-white uppercase" placeholder="------" autocomplete="off" %}
            {% endif %}
        </div>
    {% endfor %}

    <button type="submit" class="w-full py-3 px-4 bg-brand hover:bg-brand-dark text-white font-bold rounded-lg shadow-lg shadow-brand/20 transform active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2">
        <i class="ph ph-check-circle text-xl"></i>
        VALIDAR CÓDIGO
    </button>

</form>

<!-- CORREÇÃO 2: Botão de Reenviar usando a lógica nova do Allauth -->
<div class="mt-8 pt-6 border-t border-gray-100 text-center">
    <p class="text-xs text-slate-400 mb-3">Não recebeu?</p>
    
    <!-- O formulário de reenviar também posta na mesma URL, mas com action="resend" -->
    <form method="post" action="" class="inline-block">
        {% csrf_token %}
        <input type="hidden" name="action" value="resend">
        
        <button type="submit" class="text-sm font-semibold text-brand hover:text-brand-dark border border-brand/30 px-4 py-2 rounded-full hover:bg-brand-surface transition-colors">
            Solicitar Novo Código
        </button>
    </form>

    <!-- Botão de Cancelar/Logout (Caso o usuário queira trocar de conta) -->
    <div class="mt-4">
        <form method="post" action="{% url 'account_logout' %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'account_login' %}">
            <button type="submit" class="text-xs text-slate-400 hover:text-red-500 underline">
                Cancelar / Sair
            </button>
        </form>
    </div>
</div>


<script>
document. querySelector('input[name="code"]').addEventListener('input', function(e) {
    const val = e.target. value. replace(/\D/g, '');
    e.target.value = val.toUpperCase();
    
    // Auto-submit quando tiver 6 caracteres
    if (val.length === 6) {
        e.target. closest('form').submit();
    }
});
</script>


{% endblock %}
