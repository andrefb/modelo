{% load widget_tweaks %}

{% with input_style="w-full px-3 py-2 rounded-md border border-gray-300 text-slate-700 text-sm placeholder-gray-400 focus:ring-1 focus:ring-brand focus:border-brand transition-all outline-none bg-white shadow-sm" %}
{% with mono_style=input_style|add:" font-mono" cpf_style=input_style|add:" cpf-mask text-center" phone_style=input_style|add:" phone-mask" %}

<!-- Identifica칞칚o -->
<div>
    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b border-gray-100 pb-2 mb-4 flex items-center gap-2">
        <i class="ph ph-identification-card text-brand text-lg"></i> Identifica칞칚o
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
        
        <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">CNPJ <span class="text-red-500">*</span></label>
            {% if form.instance.created_at %}
                {% render_field form.cnpj class="w-full px-3 py-2 rounded-md border border-gray-200 bg-gray-50 text-slate-500 text-sm cursor-not-allowed outline-none font-mono" readonly="readonly" %}
            {% else %}
                {% render_field form.cnpj class=mono_style placeholder="00.000.000/0000-00" %}
            {% endif %}
            <p class="text-xs text-red-500 mt-1">{{ form.cnpj.errors.0 }}</p>
        </div>

        <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Inscri칞칚o Estadual</label>
            {% render_field form.state_registration class=input_style %}
        </div>

        <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Raz칚o Social <span class="text-red-500">*</span></label>
            {% render_field form.legal_name class=input_style %}
        </div>

        <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Nome Fantasia</label>
            {% render_field form.trade_name class=input_style %}
        </div>
    </div>
</div>

<!-- Contato -->
<div class="mt-8">
    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b border-gray-100 pb-2 mb-4 flex items-center gap-2">
        <i class="ph ph-phone text-brand text-lg"></i> Contato
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
        
        <div class="md:col-span-3">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Telefone</label>
            {% render_field form.phone class=phone_style %}
        </div>

        <div class="md:col-span-3">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Celular/Outro</label>
            {% render_field form.phone_2 class=phone_style placeholder="(00) 00000-0000" %}
        </div>

        <div class="md:col-span-6">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Email</label>
            {% render_field form.email class=input_style %}
        </div>

        <!-- Website (12 cols) -->
        <div class="md:col-span-12">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Website</label>
            <!-- ALTERADO: type="text" remove a valida칞칚o chata do navegador -->
            {% render_field form.website class=input_style placeholder="www.suaempresa.com.br" type="text" %}
        </div>
    </div>
</div>

<!-- Endere칞o -->
<div class="mt-8">
    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b border-gray-100 pb-2 mb-4 flex items-center gap-2">
        <i class="ph ph-map-pin text-brand text-lg"></i> Endere칞o
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
        
        <div class="md:col-span-2">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">CEP</label>
            {% render_field form.zip_code class=input_style %}
        </div>
        <div class="md:col-span-8">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Endere칞o</label>
            {% render_field form.address class=input_style %}
        </div>
        <div class="md:col-span-2">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">N칰mero</label>
            {% render_field form.number class=input_style %}
        </div>

        <div class="md:col-span-5">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Complemento</label>
            {% render_field form.complement class=input_style %}
        </div>
        <div class="md:col-span-3">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Bairro</label>
            {% render_field form.neighborhood class=input_style %}
        </div>
        <div class="md:col-span-3">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Cidade</label>
            {% render_field form.city class=input_style %}
        </div>
        <div class="md:col-span-1">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">UF</label>
            {% render_field form.state class="w-full px-1 py-2 rounded-md border border-gray-300 text-slate-700 text-sm focus:ring-1 focus:ring-brand outline-none bg-white shadow-sm text-center" %}
        </div>
    </div>
</div>

<!-- Quadro Societ치rio -->
<div class="mt-10 pt-8 border-t border-gray-100">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-2">
            <i class="ph ph-users-three text-brand text-lg"></i> Quadro Societ치rio
        </h3>
        <button type="button" id="add-partner-btn" class="text-xs font-bold text-brand bg-brand-surface hover:bg-brand/10 border border-brand/20 px-4 py-2 rounded-md transition-colors flex items-center gap-2">
            <i class="ph ph-plus-circle text-base"></i>
            Adicionar S칩cio
        </button>
    </div>

    {{ formset.management_form }}

    <div id="partners-container" class="space-y-3">
        {% for form in formset %}
            <div class="partner-row bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative group hover:border-brand/30 transition-all">
                {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}

                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nome Completo</label>
                        {% render_field form.name class=input_style placeholder="Nome do s칩cio" %}
                        <p class="text-xs text-red-500 mt-1">{{ form.name.errors.0 }}</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">CPF</label>
                        {% render_field form.cpf class=cpf_style placeholder="000.000.000-00" %}
                        <p class="text-xs text-red-500 mt-1">{{ form.cpf.errors.0 }}</p>
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Email</label>
                        {% render_field form.email class=input_style placeholder="email@exemplo.com" %}
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Telefone</label>
                        {% render_field form.phone class=phone_style placeholder="(00) 00000-0000" %}
                    </div>
                </div>

                <div class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="hidden">{{ form.DELETE }}</div> 
                    <button type="button" class="delete-row-btn bg-white text-red-500 border border-red-100 shadow-sm p-1.5 rounded-full hover:bg-red-50 transition-colors" title="Remover">
                        <i class="ph ph-trash text-lg"></i>
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Template Clone -->
    <div id="empty-form" class="hidden">
        <div class="partner-row bg-gray-50 p-4 rounded-lg border border-gray-200 border-dashed relative mt-3">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nome Completo</label>
                    {% render_field formset.empty_form.name class=input_style %}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">CPF</label>
                    {% render_field formset.empty_form.cpf class=cpf_style %}
                </div>
                <div class="md:col-span-4">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Email</label>
                    {% render_field formset.empty_form.email class=input_style %}
                </div>
                <div class="md:col-span-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Telefone</label>
                    {% render_field formset.empty_form.phone class=phone_style %}
                </div>
            </div>
            <button type="button" class="delete-row-btn absolute top-3 right-3 text-slate-400 hover:text-red-500 transition-colors">
                <i class="ph ph-x text-lg"></i>
            </button>
            <div class="hidden">{{ formset.empty_form.DELETE }}</div>
        </div>
    </div>
</div>

{% endwith %}
{% endwith %}

<script>
    document.addEventListener("htmx:load", function() {
        const els = {
            cnpj: document.getElementById('id_cnpj'),
            legal_name: document.getElementById('id_legal_name'),
            trade_name: document.getElementById('id_trade_name'),
            phone: document.getElementById('id_phone'),
            phone_2: document.getElementById('id_phone_2'),
            email: document.getElementById('id_email'),
            zip_code: document.getElementById('id_zip_code'),
            address: document.getElementById('id_address'),
            neighborhood: document.getElementById('id_neighborhood'),
            city: document.getElementById('id_city'),
            state: document.getElementById('id_state'),
            number: document.getElementById('id_number'),
            complement: document.getElementById('id_complement')
        };

        const maskCNPJ = v => v.replace(/\D/g, '').replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2').substring(0, 18);
        const maskPhone = v => { let r = v.replace(/\D/g, '').substring(0, 11); if(r.length>10) return r.replace(/^(\d\d)(\d{5})(\d{4}).*/,"($1) $2-$3"); if(r.length>5) return r.replace(/^(\d\d)(\d{4})(\d{0,4}).*/,"($1) $2-$3"); if(r.length>2) return r.replace(/^(\d\d)/,"($1) "); return r; };
        const maskCEP = v => v.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2').substring(0, 9);
        const maskCPF = v => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').replace(/(-\d{2})\d+?$/, '$1').substring(0, 14);

        if (els.cnpj) els.cnpj.addEventListener('input', e => e.target.value = maskCNPJ(e.target.value));
        if (els.phone) els.phone.addEventListener('input', e => e.target.value = maskPhone(e.target.value));
        if (els.phone_2) els.phone_2.addEventListener('input', e => e.target.value = maskPhone(e.target.value));
        if (els.zip_code) els.zip_code.addEventListener('input', e => e.target.value = maskCEP(e.target.value));

        if (els.cnpj && !els.cnpj.readOnly) {
            els.cnpj.addEventListener('blur', function(e) {
                let clean = e.target.value.replace(/\D/g, '');
                if (clean.length === 14) {
                    els.legal_name.value = "游댌 Buscando...";
                    fetch(`https://brasilapi.com.br/api/cnpj/v1/${clean}`).then(r => r.ok ? r.json() : null).then(data => {
                        if(!data) return;
                        els.legal_name.value = data.razao_social;
                        els.trade_name.value = data.nome_fantasia || data.razao_social;
                        if(data.ddd_telefone_1) els.phone.value = maskPhone(data.ddd_telefone_1);
                        if(data.ddd_telefone_2) els.phone_2.value = maskPhone(data.ddd_telefone_2);
                        if(data.email) els.email.value = data.email.toLowerCase();
                        if (data.cep) {
                            els.zip_code.value = maskCEP(data.cep);
                            els.address.value = data.logradouro;
                            els.neighborhood.value = data.bairro;
                            els.city.value = data.municipio;
                            els.state.value = data.uf;
                            els.number.value = data.numero;
                            els.complement.value = data.complemento;
                            els.number.focus();
                        }
                    }).catch(() => els.legal_name.value = "");
                }
            });
        }

        if (els.zip_code) {
            els.zip_code.addEventListener('blur', function(e) {
                let clean = e.target.value.replace(/\D/g, '');
                if (clean.length === 8) {
                    fetch(`https://viacep.com.br/ws/${clean}/json/`).then(r=>r.json()).then(data => {
                        if (!data.erro) {
                            els.address.value = data.logradouro;
                            els.neighborhood.value = data.bairro;
                            els.city.value = data.localidade;
                            els.state.value = data.uf;
                            els.number.focus();
                        }
                    });
                }
            });
        }

        const container = document.getElementById('partners-container');
        const addBtn = document.getElementById('add-partner-btn');
        const totalForms = document.getElementById('id_partners_list-TOTAL_FORMS');
        const template = document.getElementById('empty-form');

        function applyMasks(ctx) {
            ctx.querySelectorAll('.cpf-mask').forEach(i => i.addEventListener('input', e => e.target.value = maskCPF(e.target.value)));
            ctx.querySelectorAll('.phone-mask').forEach(i => i.addEventListener('input', e => e.target.value = maskPhone(e.target.value)));
        }

        if (addBtn && container) {
            addBtn.addEventListener('click', () => {
                const count = parseInt(totalForms.value);
                const div = document.createElement('div');
                div.innerHTML = template.innerHTML.replace(/__prefix__/g, count);
                const row = div.firstElementChild;
                container.appendChild(row);
                totalForms.value = count + 1;
                applyMasks(row);
            });

            container.addEventListener('click', e => {
                const btn = e.target.closest('.delete-row-btn');
                if (btn) {
                    const row = btn.closest('.partner-row');
                    const chk = row.querySelector('input[name$="-DELETE"]');
                    if (chk) { chk.checked = true; row.style.display = 'none'; } else { row.remove(); }
                }
            });
        }
        applyMasks(document);
    });
</script>